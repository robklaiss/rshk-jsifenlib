package com.roshka.sifen.internal.helpers;

import com.roshka.sifen.core.SifenConfig;
import com.roshka.sifen.core.exceptions.SifenException;
import com.roshka.sifen.internal.SOAPResponse;
import com.roshka.sifen.internal.util.SifenExceptionUtil;
import com.roshka.sifen.internal.util.SifenUtil;

import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.SSLContext;
import javax.xml.soap.MessageFactory;
import javax.xml.soap.SOAPConstants;
import javax.xml.soap.SOAPException;
import javax.xml.soap.SOAPMessage;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.logging.Logger;

/**
 * Helper encargado de manejar las peticiones SOAP.
 */
public class SoapHelper {
    private final static Logger logger = Logger.getLogger(SoapHelper.class.toString());

    

    /**
     * SOAP 1.1 message (usa text/xml + SOAPAction)
     */
    public static SOAPMessage createSoapMessage11() throws SOAPException {
        MessageFactory mf11 = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
        return mf11.createMessage();
    }
private static void setupHttpURLConnectionProperties(HttpsURLConnection httpsConnection, SifenConfig sifenConfig) {
        httpsConnection.setConnectTimeout(sifenConfig.getHttpConnectTimeout());
        httpsConnection.setReadTimeout(sifenConfig.getHttpReadTimeout());
    }

    private static boolean isConsultaRuc(String urlString) {
        if (urlString == null) return false;
        return urlString.contains("/consulta-ruc");
    }

private static void setupHttpURLConnectionHeaders(HttpsURLConnection httpsConnection, SifenConfig sifenConfig, String urlString) {
        httpsConnection.setRequestProperty("User-Agent", sifenConfig.getUserAgent());

        if (isConsultaRuc(urlString)) {
            // SOAP 1.1 para siConsRUC
            String contentType = "text/xml; charset=utf-8";
            httpsConnection.setRequestProperty("Content-Type", contentType);
            httpsConnection.setRequestProperty("Accept", "text/xml, */*");
            httpsConnection.setRequestProperty("SOAPAction", "siConsRUC");
            logger.info("HTTP Headers (consulta-ruc) - Content-Type: " + contentType + " ; SOAPAction=siConsRUC");
            return;
        }

        // Default SOAP 1.2
        String contentType = "application/soap+xml; charset=utf-8";
        httpsConnection.setRequestProperty("Content-Type", contentType);
        httpsConnection.setRequestProperty("Accept", "application/soap+xml, text/xml, */*");
        logger.info("HTTP Headers - Content-Type: " + contentType);
}

    public static SOAPMessage createSoapMessage() throws SOAPException {
        MessageFactory mf12 = MessageFactory.newInstance(SOAPConstants.SOAP_1_2_PROTOCOL);
        return mf12.createMessage();
    }

public static SOAPMessage createSoapMessage(String urlString) throws SOAPException {
        if (isConsultaRuc(urlString)) {
            MessageFactory mf11 = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
            return mf11.createMessage();
        }
        MessageFactory mf12 = MessageFactory.newInstance(SOAPConstants.SOAP_1_2_PROTOCOL);
        return mf12.createMessage();
    }

    public static SOAPMessage parseSoapMessage(InputStream is)
            throws SOAPException, IOException {
        MessageFactory mf12 = MessageFactory.newInstance(SOAPConstants.SOAP_1_2_PROTOCOL);
        return mf12.createMessage(null, is);
    }


    /**
     * Parser tolerante: detecta SOAP 1.2 vs 1.1 mirando el namespace del Envelope.
     */
    private static SOAPMessage parseSoapMessageAuto(byte[] data) throws SOAPException, IOException {
        String xml = new String(data, java.nio.charset.StandardCharsets.UTF_8);
        MessageFactory mf;
        if (xml.contains("http://www.w3.org/2003/05/soap-envelope")) {
            mf = MessageFactory.newInstance(SOAPConstants.SOAP_1_2_PROTOCOL);
        } else if (xml.contains("http://schemas.xmlsoap.org/soap/envelope/")) {
            mf = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
        } else {
            // fallback: intentar 1.2 primero, luego 1.1
            try {
                mf = MessageFactory.newInstance(SOAPConstants.SOAP_1_2_PROTOCOL);
                return mf.createMessage(null, new java.io.ByteArrayInputStream(data));
            } catch (SOAPException _e) {
                mf = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
            }
        }
        return mf.createMessage(null, new java.io.ByteArrayInputStream(data));
    }
public static SOAPMessage parseSoapMessage(InputStream is, String urlString)
            throws SOAPException, IOException {
        // Preferimos protocolo esperado por endpoint
        try {
            if (isConsultaRuc(urlString)) {
                MessageFactory mf11 = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
                return mf11.createMessage(null, is);
            }
            MessageFactory mf12 = MessageFactory.newInstance(SOAPConstants.SOAP_1_2_PROTOCOL);
            return mf12.createMessage(null, is);
        } catch (SOAPException e) {
            // Fallback: intentar el otro protocolo
            MessageFactory mf11 = MessageFactory.newInstance(SOAPConstants.SOAP_1_1_PROTOCOL);
            return mf11.createMessage(null, is);
        }
    }

    public static SOAPResponse makeSoapRequest(SifenConfig sifenConfig, String urlString, SOAPMessage soapMessage) throws SifenException {
        SOAPResponse soapResponse = new SOAPResponse();
        HttpsURLConnection httpsConnection = null;
        try {
            URL url = new URL(urlString);
            httpsConnection = (HttpsURLConnection) url.openConnection();
            if (url.getProtocol().equalsIgnoreCase("https")) {
                SSLContext sslContext = SSLContextHelper.getContextFromConfig(sifenConfig);
                httpsConnection.setSSLSocketFactory(sslContext.getSocketFactory());
            } else if (!url.getProtocol().equalsIgnoreCase("http")) {
                throw SifenExceptionUtil.invalidSOAPRequest("El protocolo " + url.getProtocol() + " es inválido");
            }

            httpsConnection.setRequestMethod("POST");
            httpsConnection.setDoOutput(true);
            setupHttpURLConnectionProperties(httpsConnection, sifenConfig);
            setupHttpURLConnectionHeaders(httpsConnection, sifenConfig, urlString);

            // Conexión
            logger.info("Conectando a: " + url);
            httpsConnection.connect();

            // Petición
            logger.info("Enviando mensaje SOAP");

            soapMessage.writeTo(httpsConnection.getOutputStream());

            // Respuesta
            soapResponse.setStatus(httpsConnection.getResponseCode());
            InputStream inputStream;
            if (soapResponse.isRequestSuccessful()) {
                inputStream = httpsConnection.getInputStream();
            } else {
                inputStream = httpsConnection.getErrorStream();
            }

            byte[] readData = SifenUtil.getByteArrayFromInputStream(inputStream);
            SOAPMessage successSoapMessage = SoapHelper.parseSoapMessageAuto(readData);
soapResponse.setSoapResponse(successSoapMessage);
            soapResponse.setRawData(readData);

            return soapResponse;
        } catch (MalformedURLException e) {
            throw SifenExceptionUtil.invalidSOAPRequest("El URL " + urlString + " es inválido: " + e.getLocalizedMessage(), e);
        } catch (IOException e) {
            throw SifenExceptionUtil.invalidSOAPRequest("Excepción de entrada/salida al realizar llamada SOAP: " + e.getLocalizedMessage(), e);
        } catch (SOAPException e) {
            throw SifenExceptionUtil.invalidSOAPRequest("Excepción de mensajería SOAP: " + e.getLocalizedMessage(), e);
        } finally {
            if (httpsConnection != null)
                httpsConnection.disconnect();
        }
    }
}